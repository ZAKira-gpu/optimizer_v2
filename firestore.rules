rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Allow authenticated users to read/write their own user profile
    match /userProfiles/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Allow authenticated users to read/write their own meals
      match /meals/{mealId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Allow authenticated users to read/write their own settings
      match /settings/{settingId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Allow authenticated users to read/write their own efficiency data
      match /efficiency/{document=**} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Allow authenticated users to read/write test documents
      match /test/{testId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // Allow authenticated users to read/write global meals collection
    match /meals/{mealId} {
      allow read, write: if request.auth != null;
    }
    
    // Allow authenticated users to read/write health data
    match /healthData/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Allow access to daily data subcollection
      match /dailyData/{date} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // Allow authenticated users to read/write step data
    match /stepData/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Allow authenticated users to read/write step tracking data (used by StepTrackerService)
    match /stepTracking/{userId}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Allow authenticated users to read/write sleep data
    match /sleepData/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Allow authenticated users to read/write sleep tracking data (used by SleepDetectionService)
    match /sleepTracking/{userId}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Allow authenticated users to read/write weekly health summaries
    match /weeklyHealthSummaries/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Allow access to summaries subcollection
      match /summaries/{weekId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
  }
}
